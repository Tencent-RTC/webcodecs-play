<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>WebCodecs Play</title>
  <style>
    canvas {
      padding: 10px;
      background: gold;
    }

    button {
      background-color: #555555;
      border: none;
      color: white;
      padding: 15px 32px;
      width: 150px;
      text-align: center;
      display: block;
      font-size: 16px;
    }
  </style>
</head>

<body>

  <video id="camera" width="640" height="480" controls="true" ></video>

  <canvas id="dst" width="640" height="480"></canvas>
  <script>


    let codec_string = "vp8";
    let socket;
    let decoder;


    function chunkToString(chunk) {

        return JSON.stringify({
            type: chunk.type,
            timestamp: chunk.timestamp,
            data :  Array.from(new Uint8Array(chunk.data))
        })
    }

    function dataToChunk(data) {

        return new EncodedVideoChunk({
            type: data.type,
            timestamp: data.timestamp,
            data: new Uint8Array(data.data),
        })
    }

    function sendEncodeChunk(chunk) {
        socket.send(chunkToString(chunk));
    }

    async function captureAndEncode() {

      let fps = 30;
      let pending_outputs = 0;
      let frame_counter = 0;

      const constraints = {
          video: {width:640,height:480},
          audio: true}
          
      const stream = await navigator.mediaDevices.getUserMedia(constraints);

      let camera = document.getElementById("camera");
      camera.srcObject = stream;
      camera.controls = true;
      camera.muted = true;


      let vtr = new VideoTrackReader(stream.getVideoTracks()[0]);

      const init = {
        output: (chunk) => {
          pending_outputs--;
          
          console.log(chunk);
          sendEncodeChunk(chunk);

        },
        error: (e) => {
          console.log(e.message);
          vtr.stop();
        }
      };

      const config = {
        codec: codec_string,
        width: 640,
        height: 480,
        bitrate: 1e6,
        framerate: fps,
      };

      let encoder = new VideoEncoder(init);
      encoder.configure(config);

      vtr.start((frame) => {
        if (pending_outputs > 30) {
          // Too many frames in flight, encoder is overwhelmed
          // let's drop this frame.
          return;
        }
        frame_counter++;
        pending_outputs++;
        const insert_keyframe = (frame_counter % 150) == 0;
        encoder.encode(frame, { keyFrame: insert_keyframe });
      });
    }


    function startDecodingAndRendering() {
      let cnv = document.getElementById("dst");
      let ctx = cnv.getContext("2d", { alpha: false });
      let ready_frames = [];

      async function renderFrame() {

        if (ready_frames.length == 0) {
          return;
        }

        let frame = ready_frames.shift();

        let bitmap = await frame.createImageBitmap();        
        ctx.drawImage(bitmap, 0, 0);        

        // Immediately schedule rendering of the next frame
        setTimeout(renderFrame, 0);
        frame.destroy();
      }

      function handleFrame(frame) {
        ready_frames.push(frame);
        setTimeout(renderFrame, 0);
      }

      const init = {
        output: handleFrame,
        error: (e) => {
          console.log(e.message);
        }
      };

      const config = {
        codec: codec_string,
        codedWidth: cnv.width,
        codedHeight: cnv.height
      };

      let decoder = new VideoDecoder(init);
      decoder.configure(config);
      return decoder;
    }

    function main() {
      if (!("VideoEncoder" in window)) {
        document.body.innerHTML = "<h1>WebCodecs API is not supported.</h1>";
        return;
      }


      let url = new URL(window.location);
      socket = new WebSocket("ws://localhost:8000/channel");

      decoder = startDecodingAndRendering();

      socket.onopen = async () => {
        captureAndEncode();
      }

      socket.onmessage = async (event) => {

          let data = JSON.parse(event.data)

         decoder.decode(dataToChunk(data));
      }
    }

    document.body.onload = main;
  </script>

</body>

</html>